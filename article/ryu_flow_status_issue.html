<!DOCTYPE html>
<html lang="zh-Hant-TW">
    <head>
        <meta charset="utf-8">
        <title>Takeshi's blog</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="">
        <meta name="author" content="Tseng Yi">
        <meta name="author" content="Takeshi">
        <meta http-equiv="Expires" content="604800" />

        <style type="text/css">
            body {
                padding-top: 40px;
                padding-bottom: 40px;
            }
            li {
                margin-bottom: 16px;
            }
        </style>

        <link rel="shortcut icon" href="images/favicon.ico">
        <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
        <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
        <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    </head>

    <body>

        <div class="ui fixed inverted menu" id="horizontal-menu">
    <div class="ui container">
        <a href="/" class="header item">
            Takeshi's Blog
        </a>
        <a id="hori-item-toc" class="item">≡</a>
        <a id="hori-item" class="item" href="/article">Article</a>
        <a id="hori-item" class="item" href="/about.html">About</a>
        <a id="hori-item" class="item" href="/cv.pdf">CV</a>
    </div>
</div>

<div class="ui sidebar inverted vertical menu" id="vertical-menu">
    <div class="ui container">
        <a href="/" class="header item">
            Takeshi's Blog
        </a>
        
        <a class="item" href="/article">Article</a>
        <a class="item" href="/about.html">About</a>
        <a class="item" href="/cv.pdf">CV</a>
    </div>
</div>


        <!-- fork me on github -->
        <a class="fork-button" href="https://github.com/TakeshiTseng/blog.takeshi.tw"><img style="position: fixed; top: 0; right: 0; border: 0; z-index: 1032;" src="/images/FMOG.png" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"></a>

        
        <div id="article-content" class="ui text container piled segment" style="min-height: 450px;">
            <h1 id="ryu--query--flow--switch-">Ryu 在 Query 含有大量 flow 的 switch 所出現的問題以及解法</h1>
<hr />

<p>今天在 Ryu mailing list 中看到有人提出了一個問題：</p>

<p><a href="http://sourceforge.net/p/ryu/mailman/message/34347766/">RYU can't get more than 21K flow entry to curl client</a></p>

<pre><code class="plain">Dear All,  
i'm using RYU v3.19 to test Noviflow switch in lab.  
[ something i did ]  
    1. push 21,000 flow through RYU to Novi switch.  
    2. using curl to query those 21,000 flow.  
during my test,  
install/get 18000 entry is OK, but with 21,000 flow, ryu can't get all 21,000 entry.  
tcpdump on RYU,  
can see Novi send much MultiPart_Reply to RYU.  
looks like ryu didn't return results to CURL client.  
i got empty list, below.
（下略）</code></pre>

<p>用簡短的說法就是他裝了一大堆的 Flow Entry 在他的 Switch 中，然後用 Ryu REST API 去取得
那一個 Switch 中的 Flow Entry，結果出來的內容卻是錯的。</p>

<p>我一開始想到的是之前聽 Rascov 說 ONOS 在有大量的 Flow Entry 時會發生錯誤，他主要問題是
大量的 Query 導致網路流量被塞滿，然後導致 OpenFlow 的 Echo 機制出了問題，但是後來看了一下信件所附的
pcap 以及 debug message 檔案，發現並不是這麼一回事。</p>

<p>於是我就從 REST API 這邊開始去 trace 看問題點釋出在哪邊，順便學一下 ofctl 實作的方法。</p>

<p>ofctl 主要有幾個東西是我們需要知道的：</p>

<ol>
  <li>waiter: 用於接收某一個指定的 Query（透過 xid 去區別）</li>
  <li>lock: 實際上是一個 hub.Event() 實體，用於等待一段時間（timeout，長度預設為一秒）</li>
  <li>msgs: 用於保存接收到的 reply</li>
</ol>

<p>在呼叫 ofctl_v1_x.get_flow_stats 時，會將 waiter 帶入，要注意的是這一個 waiter 在這一支
應用程式中只會有一個，他所儲存的內容是一個 dict 資料結構，大致的內容如下：</p>

<p>waiters -&gt; {dpid: waiter} : 每一個 switch 都會有對應的 waiter</p>

<p>waiter -&gt; {xid: (lock, msgs)} : </p>

<p>每一個事件回應的 xid 都是在送出事件是就決定好了</p>

<p>因此可以用 xid 推論回送出的事件，並且找出他的回應應該要存在哪邊（msgs），以及決定該
事件的 lock</p>

<p>這一個 lock 有兩個用途：</p>

<ul>
  <li>用於等待時間(timeout)</li>
  <li>另一個是當這一個 lock 如果有被設定（lock.is_set()）的話，則表示該事件有正常的結束回應（收到一個 flag 為 0 的 reply），否則
就將該 waiter 直接移除，隨後相同 xid 的 reply <em>將不會在被收到</em></li>
</ul>

<p>get_flow_status 中會呼叫一個名為 send_stats_request 的 method，他的內容如下：</p>

<pre><code class="python">def send_stats_request(dp, stats, waiters, msgs):
    dp.set_xid(stats)
    waiters_per_dp = waiters.setdefault(dp.id, {})
    lock = hub.Event()
    waiters_per_dp[stats.xid] = (lock, msgs)
    dp.send_msg(stats)

    lock.wait(timeout=DEFAULT_TIMEOUT)
    if not lock.is_set():
        del waiters_per_dp[stats.xid]</code></pre>

<p>參數說明如下：</p>

<ol>
  <li>dp: 表示要送往的 Switch</li>
  <li>stats: 一個 OpenFlow message，在這邊給予 xid</li>
  <li>waiters: 同剛剛的說明，他會把 lock, msgs, xid 放到這裡面</li>
  <li>msgs: 用來保存接收到的訊息</li>
</ol>

<p>再來他會將該設定的東西設定好，例如 waiters 裡面會需要有 dpid -&gt; waiter -&gt; xid -&gt; (lock, msgs) 這樣的資訊
，並且會給予要送出去的訊息一個 xid，再來就是建立 lock。</p>

<p>接者他就使用 lock.wait 去等待，最多等待一秒鐘。</p>

<p><em>問題來了</em> ，假設這一個 lock 等待了一秒鐘，但是 switch 要送的東西 <em>還沒有送完</em> ，這樣會發生什麼事情？</p>

<p>剛剛有提到，當時間到了，如果 lock.is_set() 為否的話，waiter 將會被刪除，導致送回來的訊息不會在被接收以及儲存，
我們可以從原始郵件中的 pcap 檔案看到他執行超過一秒鐘，所以導致了這一個問題發生。</p>

<p><img src="/images/ryu-flow-query-problem.png" width="600" /></p>

<h2 id="section">解決辦法</h2>
<hr />

<ul>
  <li>
    <p>最簡單的解決辦法就是將 DEFAULT_TIMEOUT 調長，讓他有充分的時間可以把所有的資訊接收完畢，但是
這樣會發生一個問題，就是當網路出現了問題導致他傳送相當的緩慢，舉例來說每次傳送間隔都是幾秒鐘，
在這樣的情況下我們也許會捨棄這一次的查詢，以避免整個應用程式被我們卡住，但我們又把 Timeout
調長了，這樣一次的查詢就是好幾秒鐘這麼久，讓整個程式相當的沒有效率。</p>
  </li>
  <li>
    <p>另一種解法就是，在每一次的 reply 時，把目前 lock 的 timeout 時間重設，但是 timeout 還是一樣的短，
這樣一來查詢的時間就比較貼近查詢的量。</p>
  </li>
</ul>

<h2 id="section-1">目前情況</h2>
<hr />

<p>在對方將 timeout 調長之後，問題就解決了，但是我會希望用第二種解法會比較好。</p>

<pre><code class="plain">HI Sir,

yes!
after change timeout to 5s, i can get all flows.

Thanks for great help

Mark</code></pre>

<h2 id="patch">後續 PATCH</h2>
<hr />

<p>後來我在 Ryu 的 Ml 裡面有提到這件事情，並且補上了 patch XD</p>

<p>Patch 主要的內容：</p>

<pre><code class="patch">diff --git a/ryu/lib/ofctl_v1_3.py b/ryu/lib/ofctl_v1_3.py  
index 8490206..5b709f3 100644  
--- a/ryu/lib/ofctl_v1_3.py  
+++ b/ryu/lib/ofctl_v1_3.py  
@@ -404,10 +404,18 @@ def send_stats_request(dp, stats, waiters, msgs):  
     dp.set_xid(stats)  
     waiters_per_dp = waiters.setdefault(dp.id, {})  
     lock = hub.Event()  
+    previous_msg_len = len(msgs)  
     waiters_per_dp[stats.xid] = (lock, msgs)  
     dp.send_msg(stats)  
   
     lock.wait(timeout=DEFAULT_TIMEOUT)  
+    current_msg_len = len(msgs)  
+  
+    while current_msg_len &gt; previous_msg_len:  
+        previous_msg_len = current_msg_len  
+        lock.wait(timeout=DEFAULT_TIMEOUT)  
+        current_msg_len = len(msgs)  
+  
     if not lock.is_set():  
         del waiters_per_dp[stats.xid]</code></pre>

<p>目前的作法就是把原先的 Hard timeout 改成 idle timeout 邏輯，在每一次有新的 reply 時就在繼續等待
，若等待後沒有任何更新，則有兩種可能：</p>

<ol>
  <li>它確實是更新完畢了。</li>
  <li>它其實還是有東西要送過來，只是兩個 reply 之間太久了（可能是網路問題），導致 reply 過不來，這時候
timeout 就發揮它真正的效用，避免整個 Ryu App 被卡住。</li>
</ol>

<p>目前（8/6 00:23）PATCH 才剛送出去，還沒有補上（畢竟他們可能在睡覺 XD），可能要等到早上才有結果。</p>



            <!-- for social media sharing -->
            <div id="sharing_area" class="ui loading segment">
                <h4>分享這篇文章 : </h4>
                <span class='st_facebook_large' displayText='Facebook'></span>
                <span class='st_googleplus_large' displayText='Google +'></span>
                <span class='st_twitter_large' displayText='Tweet'></span>
                <span class='st_linkedin_large' displayText='LinkedIn'></span>
                <span class='st_sharethis_large' displayText='ShareThis'></span>

            </div>

            <!-- for disqus -->
            <div id="disqus_thread"></div>

            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


        </div>
        

        
<div class="ui inverted vertical footer segment">
        <div class="ui container">
            <div class="ui stackable inverted divided equal height stackable grid">
                <div class="three wide column">
                    <h4 class="ui inverted header">About</h4>
                    <div class="ui inverted link list">
                        <a href="https://github.com/TakeshiTseng" class="item">Github</a>
                        <a href="https://tw.linkedin.com/in/yitseng" class="item">LinkedIn</a>
                        <a href="https://www.facebook.com/w2cnlab" class="item">W2CN Lab</a>
                        <a href="mailto:a86487817@me.com" class="item">Contact Me</a>
                    </div>
                </div>
                <div class="three wide column">
                    <h4 class="ui inverted header">Powered by</h4>
                    <div class="ui inverted link list">
                        <a href="http://fireapp.kkbox.com/" class="item">Fire.app</a>
                        <a href="https://pages.github.com/" class="item">Github pages</a>
                        <a href="http://semantic-ui.com" class="item">Semantic UI</a>
                        <a href="https://cdnjs.com/" class="item">CDNjs</a>
                        <a href="https://css.hanzi.co/" class="item">漢字標準格式</a>
                        
                        
                    </div>
                </div>
                <div class="seven wide column">
                    <h4 class="ui inverted header">License</h4>
                    <p>MIT</p>
                </div>
            </div>
        </div>
    </div>

        <!-- Le javascript
================================================== -->
        <!-- Placed at the end of the document so the pages load faster -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-alpha1/jquery.min.js"></script>
        <script src="/javascripts/semantic.min.js"></script>
        <script src="/javascripts/blog.js"></script>
        
        <script src="//cdnjs.cloudflare.com/ajax/libs/Han/3.2.5/han.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script type="text/javascript">var switchTo5x=true;</script>
        <script type="text/javascript" src="http://ws.sharethis.com/button/buttons.js"></script>
        <script type="text/javascript">
            stLight.options({publisher: "b8f81d63-2a0d-4819-b08f-9e81fe389372", doNotHash: false, doNotCopy: false, hashAddressBar: false});

            setTimeout(function() {
                $('#sharing_area').removeClass('loading');
            }, 1500);

        </script>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES * * */
            var disqus_shortname = 'takeshiblog';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>


        
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                                    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-41072125-3', 'auto');
            ga('send', 'pageview');

        </script>
        <script>
            Han($('#article-content')[0]).render()
        </script>
        
    </body>
</html>

<link href="/stylesheets/style.css" media="screen" rel="stylesheet" type="text/css" /><link rel="stylesheet" media="all" href="//cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.0.8/semantic.min.css">
<link rel="stylesheet" media="all" href="//cdnjs.cloudflare.com/ajax/libs/Han/3.2.5/han.min.css">
<link rel="stylesheet" media="all" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/styles/default.min.css">
<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
<!--[if lt IE 9]>
<script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<!-- Le fav and touch icons -->